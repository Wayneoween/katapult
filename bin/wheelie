#!/usr/bin/env ruby

def wheelie_gemfile_line
  gem_line = "gem 'wheelie'"

  wheelie_bin_dir = File.expand_path(__dir__)
  if ENV['PATH'].include?(wheelie_bin_dir)
    gem_line << ", path: '../../..'"

    puts <<-TEST_MESSAGE

* The PATH environment variable contains wheelie's bin/ directory (#{wheelie_bin_dir}),
* so this binary is probably run from a gem integration test. Hence, install
* wheelie with the :path option so the correct version of wheelie is used.
* In Gemfile: #{gem_line}

    TEST_MESSAGE
  end

  gem_line
end

case ARGV.shift
when 'target'
  app_name = ARGV.shift

  # new Rails app
  system "rails new #{app_name} --skip-test-unit --skip-bundle --database mysql"
  Dir.chdir app_name

  # install wheelie
  File.open('Gemfile', 'a') { |file| file.puts(wheelie_gemfile_line) }
  system 'bundle install'
  system 'bundle exec rails generate wheelie:install'
  system 'bundle exec rails generate wheelie:basics'

when 'fire'
  puts 'Loading ...'
  system 'rails generate wheelie:render lib/wheelie/metamodel.rb'

else
  puts 'Usage: wheelie [target APP_NAME | render]'
end
